import java.sql.*;
import java.util.ArrayList;
import java.util.Arrays;

public class NVQLExploit {

    static String preConddisplay(ArrayList<String> securityCond, ArrayList<ArrayList<String>> EntityTypeNameList) {
        String PreCondSyntax = "";
        for (int i = 0; i < securityCond.size(); i++) {

            if (i >= 1)
                PreCondSyntax = PreCondSyntax + ", " + securityCond.get(i);
            else
                PreCondSyntax = PreCondSyntax + securityCond.get(i);

            for (int j = 0; j < EntityTypeNameList.get(i).size(); j++) {

                if (j == 0)
                    PreCondSyntax = PreCondSyntax + " (" + EntityTypeNameList.get(i).get(j);
                else if (EntityTypeNameList.get(i).size() == 4 && (j == 1))
                    PreCondSyntax = PreCondSyntax + "." + EntityTypeNameList.get(i).get(j);
                else if (EntityTypeNameList.get(i).size() == 5 && (j == 1 || j == 4))
                    PreCondSyntax = PreCondSyntax + ":" + EntityTypeNameList.get(i).get(j);
                else
                    PreCondSyntax = PreCondSyntax + " " + EntityTypeNameList.get(i).get(j);

                if (j == EntityTypeNameList.get(i).size() - 1)
                    PreCondSyntax = PreCondSyntax + ")";
            }

        }

        return PreCondSyntax;
    }

    static String postConddisplay(ArrayList<String> securityCond, ArrayList<ArrayList<String>> EntityTypeNameList) {
        String PostCondSyntax = "";
        for (int i = 0; i < securityCond.size(); i++) {

            if (i >= 1)
                PostCondSyntax = PostCondSyntax + ", " + securityCond.get(i);
            else
                PostCondSyntax = PostCondSyntax + securityCond.get(i);

            for (int j = 0; j < EntityTypeNameList.get(i).size(); j++) {

                if (j == 0)
                    PostCondSyntax = PostCondSyntax + " (" + EntityTypeNameList.get(i).get(j);
                else if (EntityTypeNameList.get(i).size() == 4 && (j == 1))
                    PostCondSyntax = PostCondSyntax + "." + EntityTypeNameList.get(i).get(j);
                else if (EntityTypeNameList.get(i).size() == 5 && (j == 1 || j == 4))
                    PostCondSyntax = PostCondSyntax + ":" + EntityTypeNameList.get(i).get(j);
                else
                    PostCondSyntax = PostCondSyntax + " " + EntityTypeNameList.get(i).get(j);

                if (j == EntityTypeNameList.get(i).size() - 1)
                    PostCondSyntax = PostCondSyntax + ")";
            }

        }

        return PostCondSyntax;
    }

    static Boolean existsExploit(Connection pgsqlCon) throws Exception {
        String query;
        Boolean exists = false;

        return (exists);
    }

    static String PreSecCondNames(String expTypeName, Connection pgsqlCon) throws Exception {

        // String query = "SELECT \"Precond\" FROM \"EXPLOIT_TYPE_DEF\" WHERE
        // \"Exploit_Type_Name\" = '" + expTypeName
        // + "'";
        String query = "MATCH (n: `EXPLOIT_TYPE_DEF`: `" + expTypeName + "` {}) RETURN (n.`PreCondList`)";

        // System.out.println(query);
        PreparedStatement statement = pgsqlCon.prepareStatement(query);
        ResultSet result = statement.executeQuery();
        result.next();
        // System.out.println("@" + query);
        return (result.getString(1));
    }

    static String PreSecCondNames_Modified(String expTypeName, Connection pgsqlCon) throws Exception {

        // String query = "SELECT \"Precond\" FROM \"EXPLOIT_TYPE_DEF\" WHERE
        // \"Exploit_Type_Name\" = '" + expTypeName
        // + "'";
        String str_modify = "";
        String query = "MATCH (n: `EXPLOIT_TYPE_DEF`: `" + expTypeName + "`) RETURN (n.`PreCondList`)";
        // System.out.println(query);
        PreparedStatement statement = pgsqlCon.prepareStatement(query);
        ResultSet result = statement.executeQuery();
        result.next();
        // System.out.println("@" + query);
        int flag = 0;
        for (int i = 0; i < result.getString(1).length(); i++) {
            if (result.getString(1).charAt(i) == '(')
                flag = 1;
            else if (result.getString(1).charAt(i) == ')') {
                flag = 0;
                continue;
            }
            if (flag == 0)
                str_modify = str_modify + result.getString(1).charAt(i);
        }
        // System.out.println("$$" + str_modify);
        return (str_modify);
    }

    static void createExploit(String expTypeName, String attrValList, ArrayList<String> securityCond,
            ArrayList<ArrayList<String>> EntityRelCondList, ArrayList<String> securityCond1,
            ArrayList<ArrayList<String>> EntityRelCondList1, Connection pgsqlCon) {

        try {
            if (NVQLExploitType.existsExploitType(expTypeName, pgsqlCon))
                beginExploit(expTypeName, attrValList, securityCond, EntityRelCondList, securityCond1,
                        EntityRelCondList1, pgsqlCon);
            else {
                System.out.println("ERROR.NVQLExploit: Exploit-Type <" + expTypeName + "> is not defined");
                System.exit(0);
            }
        } catch (Exception e) {
            System.out.println("NVQLcreateExploit: PostgreSQL Error");
            System.out.println(e);
            System.exit(0);
        }

    }

    static void beginExploit(String expTypeName, String attrValList, ArrayList<String> securityCond,
            ArrayList<ArrayList<String>> EntityRelCondList, ArrayList<String> securityCond1,
            ArrayList<ArrayList<String>> EntityRelCondList1, Connection pgsqlCon) {

        try {
            String datalist = "", new_datalist = "";
            String query, create_query = "";
            String valList1 = "", valList2 = "";
            String secCondNameVal = "", secCondNameVal1 = "";
            ArrayList<String> preList = new ArrayList<>();
            ArrayList<String> postList = new ArrayList<>();
            ArrayList<String> preNumList = new ArrayList<>();
            ArrayList<String> postNumList = new ArrayList<>();

            datalist = NVQLExploitType.getAttrDefList(expTypeName, pgsqlCon);
            // System.out.println(datalist);
            new_datalist = NVQLSecCondType.getModAttrDefList(datalist, pgsqlCon);
            datalist = new_datalist;
            // System.out.println(datalist);
            String attrList = "", valList = "";
            NVQLAttrDefList aDefList = null;
            NVQLAttrValList aValList = null;
            int pos, ctr = 0;
            // System.out.println("Datalist = "+datalist);
            // datalist = datalist + ",";

            if (datalist != null && datalist != "") {

                if (!attrValList.isEmpty()) {
                    aDefList = new NVQLAttrDefList(datalist);
                    aValList = new NVQLAttrValList(attrValList);

                    for (String attr : aValList.getAttrList()) {
                        if (!aDefList.existsAttr(attr)) {
                            System.out.println("ERROR.NVQLExploit: Undefined attribute <" + attr + ">");
                            System.exit(0);
                            return;
                        }
                    }
                    // System.out.println("@@" + checkUniquenessConstraint(aValList, pgsqlCon));

                    if (aValList.getAttrList().size() != aDefList.getAttrList().size()) {
                        System.out.println("WARNING: No. of Attributes in Creation = [ " + aValList.getAttrList().size()
                                + " ] & Defintion = [ " + aDefList.getAttrList().size() + " ] are unequal ");

                        // return; if we uncomment return then if no. of attributes in
                        // definition and
                        // creation doesnt match then we cannot create
                    }
                    attrList = aValList.getAttrList4SQL(); // Comma separated list of
                    // attribute
                    // names
                    // (within
                    // double quotes) to be used in
                    // INSERT
                    // statement
                    valList = aValList.getValueList4SQL_Modified(aDefList); // Comma separated list
                    // of values
                    // to be
                    // used in INSERT
                    // statement
                    // ArrayList<String> ListofsecCond = new ArrayList<String>(
                    // Arrays.asList(PreSecCondNames(expTypeName, pgsqlCon).replace(" ",
                    // "").split(",")));
                    ArrayList<String> ListofsecCond = new ArrayList<String>(
                            Arrays.asList(PreSecCondNames_Modified(expTypeName, pgsqlCon).replace(" ", "").split(",")));

                    if (valList != null && !valList.isEmpty()) {

                        for (int i = 0; i < securityCond.size(); i++) {

                            if (!ListofsecCond
                                    .contains(securityCond.get(i).substring(securityCond.get(i).indexOf(":") + 1))) {
                                // System.out.println(ListofsecCond);
                                // System.out.println(ListofsecCond
                                // .contains(securityCond.get(i).substring(securityCond.get(i).indexOf(":") +
                                // 1)));

                                System.out.println("ERROR.NVQLExploit: Security Condition Type <"
                                        + securityCond.get(i).substring(securityCond.get(i).indexOf(":") + 1)
                                        + "> is not mentioned in definition");
                                System.exit(0);
                                return;
                            }
                            if (!NVQLSecCondType.existsSecCondType(
                                    securityCond.get(i).substring(securityCond.get(i).indexOf(":") + 1), pgsqlCon)) {
                                System.out.println("ERROR.NVQLExploit: Security Condition type <"
                                        + securityCond.get(i).substring(securityCond.get(i).indexOf(":") + 1)
                                        + "> is not defined");
                                System.exit(0);
                                return;
                            }

                            if (NVQLSecCond.existsSecCond(
                                    securityCond.get(i).substring(securityCond.get(i).indexOf(":") + 1),
                                    EntityRelCondList.get(i), pgsqlCon) == null) {
                                System.out.println("ERROR.NVQLExploit: Security Condition has no Attribute named as \""
                                        + EntityRelCondList.get(i).get(1) + "\"");
                                System.exit(0);
                                return;

                            } else if (!NVQLSecCond.existsSecCond(
                                    securityCond.get(i).substring(securityCond.get(i).indexOf(":") + 1),
                                    EntityRelCondList.get(i), pgsqlCon)) {
                                System.out.println("ERROR.NVQLExploit: Security Condition "
                                        + securityCond.get(i).substring(securityCond.get(i).indexOf(":") + 1) + " with "
                                        + EntityRelCondList.get(i).get(1) + " "
                                        + EntityRelCondList.get(i).get(2).replace("==", "=") + " "
                                        + EntityRelCondList.get(i).get(3) + " does not exist");

                                System.exit(0);
                                return;
                            }

                            // System.out.println("^^" + NVQLSecCond.SecCondName(
                            // securityCond.get(i).substring(securityCond.get(i).indexOf(":") + 1),
                            // EntityRelCondList.get(i), pgsqlCon) + "^^");

                            pos = NVQLExploitType.existsExploitTypeSecCondPosition(expTypeName, "Precond",
                                    securityCond.get(i).substring(securityCond.get(i).indexOf(":") + 1), pgsqlCon);

                            // System.out.println("^^" + pos + "^^");
                            String secAttr = "";
                            if (pos <= -1) {
                                System.out.println(
                                        "ERROR.NVQLExploit: Security Pre-Condition doesn't exists and it is in position "
                                                + pos);
                                System.exit(0);
                                return;
                            }

                            secCondNameVal = NVQLSecCond.SecCondName(
                                    securityCond.get(i).substring(securityCond.get(i).indexOf(":") + 1),
                                    EntityRelCondList.get(i), pgsqlCon);

                            secAttr = NVQLExploitType.corresSecCondAttrVal(expTypeName, "Precond_Attr_Val_List", pos,
                                    pgsqlCon);
                            // System.out.println("**" + secAttr + "**");

                            if (!NVQLSecCond.existsexpDefCondition(
                                    securityCond.get(i).substring(securityCond.get(i).indexOf(":") + 1), secCondNameVal,
                                    secAttr, pgsqlCon)) {
                                System.out.println(
                                        "ERROR.NVQLExploit: The Security Pre-Condition's of the exploit-type definition doesn't have ["
                                                + secAttr.replace("$", "").replace("#", "") + "] ");
                                System.exit(0);
                                return;
                            }

                            if (valList1.equals(""))
                                valList1 = valList1 + ":\"" + secCondNameVal + "\"";
                            else
                                valList1 = valList1 + ",:\"" + secCondNameVal + "\"";
                            // System.out.println("Valist1: " + valList1);
                            String new_secAttr = secAttr;
                            if (!new_secAttr.isEmpty()) {
                                new_secAttr = new_secAttr.substring(new_secAttr.indexOf("(") + 1,
                                        new_secAttr.indexOf(")"));
                                // System.out.println("new!!" + new_secAttr);
                                new_secAttr = ", "
                                        + new_secAttr.replace("$", "`").replace("#\"", "\"").replace("\"#", "\"");
                                // System.out.println("@@ " + new_secAttr);
                            }
                            preList.add("(n" + ctr + ": `"
                                    + securityCond.get(i).substring(securityCond.get(i).indexOf(":") + 1)
                                    + "` {`name`: \"" + secCondNameVal + "\"" + new_secAttr + "})");
                            preNumList.add("(n" + ctr + ")");
                            ctr++;
                            // System.out.println("query: " + query);

                        }

                        for (int i = 0; i < securityCond1.size(); i++) {

                            if (!ListofsecCond
                                    .contains(securityCond1.get(i).substring(securityCond1.get(i).indexOf(":") + 1))) {
                                System.out.println("ERROR.NVQLExploit: Security Condition Type <"
                                        + securityCond1.get(i).substring(securityCond1.get(i).indexOf(":") + 1)
                                        + "> is not mentioned in definition");
                                System.exit(0);
                                return;
                            }
                            if (!NVQLSecCondType.existsSecCondType(
                                    securityCond1.get(i).substring(securityCond1.get(i).indexOf(":") + 1), pgsqlCon)) {
                                System.out.println("ERROR.NVQLExploit: Security Condition type <"
                                        + securityCond1.get(i).substring(securityCond1.get(i).indexOf(":") + 1)
                                        + "> is not defined");
                                System.exit(0);
                                return;
                            }

                            if (NVQLSecCond.existsSecCond(
                                    securityCond1.get(i).substring(securityCond1.get(i).indexOf(":") + 1),
                                    EntityRelCondList1.get(i), pgsqlCon) == null) {
                                System.out.println("ERROR.NVQLExploit: Security Condition has no Attribute named as \""
                                        + EntityRelCondList1.get(i).get(1) + "\"");
                                System.exit(0);
                                return;

                            } else if (!NVQLSecCond.existsSecCond(
                                    securityCond1.get(i).substring(securityCond1.get(i).indexOf(":") + 1),
                                    EntityRelCondList1.get(i), pgsqlCon)) {
                                System.out.println("ERROR.NVQLExploit: Security Condition "
                                        + securityCond1.get(i).substring(securityCond1.get(i).indexOf(":") + 1)
                                        + " with " + EntityRelCondList1.get(i).get(1) + " "
                                        + EntityRelCondList1.get(i).get(2).replace("==", "=") + " "
                                        + EntityRelCondList1.get(i).get(3) + " does not exist");

                                System.exit(0);
                                return;
                            }

                            // System.out.println("^^" +
                            // NVQLSecCond.SecCondName(securityCond1.get(i).substring(securityCond1.get(i).indexOf(":")
                            // + 1), EntityRelCondList1.get(i), pgsqlCon) + "^^");

                            pos = NVQLExploitType.existsExploitTypeSecCondPosition(expTypeName, "Postcond",
                                    securityCond1.get(i).substring(securityCond1.get(i).indexOf(":") + 1), pgsqlCon);

                            // System.out.println("^^" + pos + "^^");
                            String secAttr1 = "";
                            if (pos <= -1) {
                                System.out.println(
                                        "ERROR.NVQLExploit: Security Post-Condition doesn't exists and it is in position "
                                                + pos);
                                System.exit(0);
                                return;
                            }

                            secCondNameVal1 = NVQLSecCond.SecCondName(
                                    securityCond1.get(i).substring(securityCond1.get(i).indexOf(":") + 1),
                                    EntityRelCondList1.get(i), pgsqlCon);

                            secAttr1 = NVQLExploitType.corresSecCondAttrVal(expTypeName, "Postcond_Attr_Val_List", pos,
                                    pgsqlCon);
                            // System.out.println("**" + secAttr1 + "**");

                            if (!NVQLSecCond.existsexpDefCondition(
                                    securityCond1.get(i).substring(securityCond1.get(i).indexOf(":") + 1),
                                    secCondNameVal1, secAttr1, pgsqlCon)) {
                                System.out.println(
                                        "ERROR.NVQLExploit: The Security Post-Condition's of the exploit-type definition doesn't have ["
                                                + secAttr1.replace("$", "").replace("#", "") + "] ");
                                System.exit(0);
                                return;
                            }

                            if (valList2.equals(""))
                                valList2 = valList2 + ":\"" + secCondNameVal1 + "\"";
                            else
                                valList2 = valList2 + ",:\"" + secCondNameVal1 + "\"";

                            // System.out.println("valList2: " + valList2);
                            String new_secAttr1 = secAttr1;
                            if (!new_secAttr1.isEmpty()) {
                                new_secAttr1 = new_secAttr1.substring(new_secAttr1.indexOf("(") + 1,
                                        new_secAttr1.indexOf(")"));
                                // System.out.println("new!!" + new_secAttr1);
                                new_secAttr1 = ", "
                                        + new_secAttr1.replace("$", "`").replace("#\"", "\"").replace("\"#", "\"");
                                // System.out.println("@@ " + new_secAttr1);
                            }
                            postList.add("(n" + ctr + ": `"
                                    + securityCond1.get(i).substring(securityCond1.get(i).indexOf(":") + 1)
                                    + "` {`name`: \"" + secCondNameVal1 + "\"" + new_secAttr1 + "})");
                            postNumList.add("(n" + ctr + ")");
                            ctr++;
                            // System.out.println("query: " + query);
                        }

                        // query = "INSERT INTO \"" + expTypeName + "\" (" + attrList
                        // + ",\"Precond_List\",\"Postcond_List\") VALUES (" + valList + ",'" + valList1
                        // + "','"
                        // + valList2 + "')";
                        // System.out.println(attrList + "^^^" + "***");

                        create_query = "(n: `" + expTypeName + "`{" + valList + "})";
                        // System.out.println("-->" + create_query);
                        query = "CREATE " + create_query + " RETURN (n)";
                        PreparedStatement statement3 = pgsqlCon.prepareStatement(query);
                        statement3.executeUpdate();
                        // System.out.println("@" + query);
                        System.out.println("1 node added Values: [(" + attrList + ") , (" + valList
                                + ") ] inserted in Table '" + expTypeName + "'");

                        query = "MATCH " + create_query + " ";
                        for (int preloop = 0; preloop < preList.size(); preloop++) {
                            query = query + "MATCH " + preList.get(preloop) + " ";
                        }
                        for (int postloop = 0; postloop < postList.size(); postloop++) {
                            query = query + "MATCH " + postList.get(postloop) + " ";
                        }
                        for (int preloop = 0; preloop < preNumList.size(); preloop++) {
                            query = query + "CREATE (n)<-[:`PRECOND`]-" + preNumList.get(preloop) + " ";
                            // System.out.println("@" + query);
                        }
                        for (int postloop = 0; postloop < postNumList.size(); postloop++) {
                            query = query + "CREATE (n)-[:`POSTCOND`]->" + postNumList.get(postloop) + " ";
                            // System.out.println("@" + query);
                        }
                        query = query + "RETURN (n)";
                        // System.out.println(query);
                        PreparedStatement statement4 = pgsqlCon.prepareStatement(query);
                        statement4.executeUpdate();
                        // System.out.println("@" + query);
                        System.out.println("The node gets its relationships attached: [(" + valList1.substring(1)
                                + ") , (" + valList2.substring(1) + ")] inserted in Table '" + expTypeName + "'");

                    }
                }

            }

        } catch (Exception e) {
            System.out.println("NVQLbeginExploit: PostgreSQL Error");
            System.out.println(e);
            System.exit(0);
        }
        return;

    }

}